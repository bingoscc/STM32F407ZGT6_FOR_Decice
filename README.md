# STM32F407ZGT6 嵌入式控制系统

## 项目概述

这是一个基于STM32F407ZGT6微控制器的嵌入式控制系统，使用FreeRTOS实时操作系统、LWIP网络协议栈和STM32 HAL库开发。主要功能包括电机角度控制、UDP网络通信、以太网配置、GPIO状态监控等。

## 主要功能

### 1. 电机控制系统
- **编码器读取**：实时读取TIM3编码器脉冲，实现角度反馈
- **角度控制**：支持正转(CW)和反转(CCW)角度控制
- **闭环控制**：基于编码器反馈的角度闭环控制
- **状态管理**：电机状态包括停止、正转、反转

### 2. 网络通信系统
- **UDP通信**：实现UDP客户端功能，支持指令接收和状态发送
- **协议格式**：自定义10字节帧格式，包含帧头、指令类型、数据和校验和
- **双向通信**：接收控制指令，发送状态反馈和GPIO状态

### 3. 网络配置系统
- **串口配置**：通过UART1进行网络参数配置
- **Flash存储**：网络配置持久化存储到Flash Sector 11
- **配置模式**：上电时检测配置模式，支持动态配置IP、网关等参数

### 4. GPIO监控系统
- **多路监控**：监控16路GPIO输入状态
- **状态反馈**：GPIO状态变化时通过UDP发送反馈
- **实时性**：5ms周期检测GPIO状态变化

### 5. 系统架构
- **FreeRTOS**：多任务实时操作系统
- **LWIP**：轻量级TCP/IP协议栈
- **HAL库**：STM32硬件抽象层

## 硬件接口

### 电机控制接口
- **编码器**：TIM3 (PA6/PA7)
- **方向控制**：PG5/PG6
- **PWM输出**：TIM3 CH1 (PC6)

### 网络接口
- **以太网**：LAN8742 PHY
- **UDP端口**：
  - 本地接收端口：8041
  - 本地发送端口：8080

### 串口接口
- **UART1**：配置接口和调试输出 (PA9/PA10)
- **UART4**：备用串口 (PA0/PA1)
- **USART3**：备用串口 (PD8/PD9)

### GPIO监控接口
- **输入引脚**：
  - PE4, PC13, PF0, PF1, PF2, PF9, PF10, PC0
  - PC2, PC3, PA0, PA3, PA6, PF11, PF12, PF13

### CAN接口
- **CAN1**：备用通信接口 (PD0/PD1)
- **CAN2**：备用通信接口 (PB5/PB6)

## 软件架构

### 任务结构
```
优先级从高到低：
1. 默认任务 (osPriorityNormal)
2. 以太网任务 (osPriorityNormal)
3. GPIO监控任务 (osPriorityLow2)
4. 电机任务 (osPriorityLow1)
5. 编码器任务 (osPriorityLow)
6. UDP LED任务 (osPriorityLow3)
```

### 主要任务函数

#### StartEncoderTask
- **功能**：编码器脉冲读取和累计
- **周期**：20ms
- **互斥锁**：使用MotorVarMutex保护全局变量

#### StartMoterTask
- **功能**：电机角度控制执行
- **控制逻辑**：基于目标角度的闭环控制
- **状态管理**：自动停止和任务删除

#### StartETHTask
- **功能**：网络初始化和UDP通信
- **初始化流程**：等待网络就绪，初始化UDP
- **超时处理**：10秒网络连接超时

#### StartGPIOMonitorTask
- **功能**：GPIO状态监控和反馈
- **检测周期**：5ms
- **反馈机制**：状态变化时UDP发送

#### UDP_Recv_Callback
- **功能**：UDP数据接收处理
- **协议解析**：帧头校验、指令解析、校验和验证
- **指令处理**：
  - 0x02：控制指令（电机控制）
  - 0x03：读取指令（状态反馈）

#### UDP_Send_Data
- **功能**：UDP数据发送
- **重试机制**：发送失败时自动重试
- **错误处理**：详细的错误码处理

### 配置函数

#### MX_LWIP_Init
- **功能**：LWIP协议栈初始化
- **配置检测**：串口检测配置模式
- **Flash加载**：从Flash加载网络配置

#### configure_network_parameters
- **功能**：串口交互式网络配置
- **参数配置**：IP地址、子网掩码、网关、目标IP、端口
- **Flash保存**：配置完成后保存到Flash

#### save_config_to_flash
- **功能**：网络配置保存到Flash
- **同步保护**：使用互斥锁保护Flash操作
- **错误处理**：完整的擦写错误处理

#### load_config_from_flash
- **功能**：从Flash加载网络配置
- **数据验证**：魔数和CRC校验
- **同步保护**：使用互斥锁保护读取操作

### 工具函数

#### parse_ip_string
- **功能**：IP地址字符串解析
- **格式验证**：点分十进制格式验证

#### calculate_crc
- **功能**：简单累加和CRC计算
- **用途**：Flash数据完整性校验

#### uart_printf
- **功能**：UART调试输出封装
- **错误处理**：传输失败时的处理

## 通信协议

### UDP帧格式
```
Byte 0: 帧头 (0x55: 控制指令, 0x33: 响应帧)
Byte 1: 指令类型 (0x02: 控制, 0x03: 读取)
Byte 2: 电机状态 (0: 停止, 1: 正转, 2: 反转)
Byte 3: 数据字节3
Byte 4: 数据字节4
Byte 5: 数据字节5
Byte 6: 数据字节6
Byte 7: 数据字节7
Byte 8: 数据字节8
Byte 9: 校验和 (前9字节累加和)
```

### 控制指令格式 (Byte1 = 0x02)
```
Byte 2: 方向 (0: 停止, 1: 正转, 2: 反转)
Byte 3: 目标角度高8位
Byte 4: 目标角度低8位
```

### 读取响应格式 (Byte1 = 0x03)
```
Byte 2: 电机状态
Byte 3: GPIO状态低8位
Byte 4: GPIO状态高8位
```

## 配置说明

### 默认网络配置
- **IP地址**：192.168.1.100
- **子网掩码**：255.255.255.0
- **网关**：192.168.1.1
- **目标IP**：192.168.1.3
- **目标端口**：8080

### 配置模式进入
上电后500ms内通过UART1发送字符 'C' 或 'c' 进入配置模式。

### Flash存储布局
- **地址**：0x080E0000 (Sector 11)
- **大小**：128KB
- **数据结构**：NetworkConfigTypeDef (28字节)

## 构建和部署

### 开发环境
- **IDE**：STM32CubeIDE 或 VS Code
- **编译器**：arm-none-eabi-gcc
- **构建系统**：CMake + Ninja

### 依赖项
- **FreeRTOS**：V10.4.6
- **LWIP**：V2.1.3
- **STM32F4 HAL**：V1.27.1

### 构建命令
```bash
mkdir build
cd build
cmake .. -DCMAKE_BUILD_TYPE=Debug
ninja
```

### 烧录
使用ST-Link或J-Link烧录生成的.elf或.hex文件。

## 调试和监控

### 串口调试
- **波特率**：115200
- **数据位**：8
- **停止位**：1
- **校验位**：无

### 调试信息
系统运行时通过UART1输出详细的调试信息，包括：
- 任务创建状态
- 网络连接状态
- UDP通信状态
- 电机控制状态
- 错误信息

## 注意事项

1. **Flash操作同步**：所有Flash操作使用互斥锁保护，确保线程安全
2. **网络超时**：网络初始化有10秒超时，避免无限等待
3. **任务优先级**：合理设置任务优先级，确保实时性要求
4. **内存管理**：注意FreeRTOS堆栈大小设置，避免栈溢出
5. **中断处理**：HAL库函数在中断中调用时需要注意上下文

## 版本信息

- **版本**：1.0.0
- **日期**：2026年01月11日
- **作者**：BINGOSCC
- **许可证**：MIT License
